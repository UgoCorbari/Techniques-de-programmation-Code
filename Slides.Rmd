---
title: "Techniques de programmation : Résumé automatisé des rencontres footballistiques"
author: "CORBARI UGO - SCHNEIDER HUGO"
date: "2025-01-14"
output: 
  ioslides_presentation:
    widescreen: true
    smaller: true
    highlight: "monokai"
---

## Sommaire

-   **I. Introduction**
    -   Présentation du projet et principaux objectifs.
-   **II. Extraction des données pour un unique match**
    -   Récupération et nettoyage des données depuis le site Transfermarkt.
    -   Analyse des données principales : équipes, score, spectateurs, date, stade, etc...
-   **III. Création d'un résumé à partir des différentes données collectées**
    -   Structuration des données extraites.
    -   Génération d'un résumé narratif détaillé.
-   **IV. Automatisation du processus et fonction finale**
    -   Assemblage des fonctions.
    -   Génération automatisée d'un résumé narratif détaillé pour n'importe quel match.

## I. Introduction

### Présentation du projet

-   **Contexte :**
    -   Projet lié à l'Unité d'enseignements "Techniques de programmation".
    -   Développement d'un programme générant des **résumés de matchs de football**.
    -   Utilisation des données du site *Transfermarkt*.
-   **Objectif principal :**
    -   Automatiser la récupération, l'analyse, et la structuration des données pour produire un résumé narratif détaillé.
-   **Extraction et analyse des données :**
    -   Nettoyage et structuration des données HTML.
    -   Identification des équipes, du score, des buteurs, et des moments clés.
    -   Production de différentes fonctions.
-   **Génération du résumé et automatisation :**
    -   Produire un résumé narratif automatique pour n'importe quel match.
    -   Rendre le processus entièrement automatisé et réutilisable.

## II. Extraction des données pour un unique match

-   **Récupération des données d'un match de football depuis le site "Transfermarkt".**
    -   "Transfermarkt" est un site web allemand axé sur le football proposant des informations sur les résultats, les transferts ainsi que des statistiques.
    -   L'un des 25 sites allemands les plus visités et l'un des principaux sites sportifs.
-   **Structure de la page web ciblée.**
    -   Plusieurs encadrés structurant la page web ciblée
    -   Encadré 1 : Informations clées telles que la compétition dans laquelle se déroule le match, les équipes impliquées ainsi que le résultat final
    -   Frise chronologique présentant le déroulé du match avec des informations tels que les changements, les buts et les cartons distribués.
    -   Encadré 2 : Compositions des équipes
    -   Encadré 3 : Données liées aux buts marqués pendant le match, nom du buteur, nom du du passeur décisif, la minute à laquelle chaque but a été inscrit.

## Principales données de l'encadré 1

```{r echo=TRUE}
page <- read_html(clean_html)

compet <- page %>% html_node(".direct-headline__header") %>%  html_text(trim = TRUE)            # Compétition

T.home <- page %>% html_node(".sb-team.sb-heim .sb-vereinslink") %>% html_text(trim = TRUE)     # Equipe Domicile

T.away <- page %>% html_node(".sb-team.sb-gast .sb-vereinslink") %>% html_text(trim = TRUE)     # Equipe Exterieur

result <- page %>% html_node(".sb-endstand") %>%html_text(trim = TRUE)                          # Résultat

spec <- page %>% html_node(".sb-zusatzinfos strong") %>% html_text(trim = TRUE)                 # Spectateurs

date <- page %>% html_node(".sb-datum.hide-for-small") %>% html_text(trim = TRUE)               # Date du match

Stade <- page %>% html_node(".sb-zusatzinfos a") %>% html_text(trim = TRUE)                     # Nom du stade

# Résumé de ces informations
cat(sprintf("Compétition: %s\nMatch: %s %s %s\nSpectateurs: %s\nDate et heure: %s\nStade: %s\n",
            compet, T.home, result, T.away, spec, date, Stade))
```

## Frise chronologique du match sous l'encadré 1

-   Création d'une foncrtion pour récupérer les minutes auxqueles ont lieux les buts.

```{r echo=TRUE}
# Extraction des minutes en fonction de leurs positions dans la frise 
# La frise présente tous les évènements du match, tels que les changements, les buts ou encore les cartons. 
# On se concentre dans notre cas sur les buts 
# Objectif : Filtrer uniquement les événements de buts
but_elements <- page %>%
  html_nodes(".sb-leiste-ereignis span.sb-sprite.sb-tor") %>% html_nodes(xpath = "..") %>%html_attr("style")                                          
# Les éléments de la frise sont définis en fonction de leurs positions, on convertit alors la position en minutes
extract_minutes <- function(style) {
  if (grepl("left:", style)) {
    percent <- as.numeric(sub(".*left: ([0-9.]+)%;.*", "\\1", style))
    return(round((percent * 90) / 100, 0))  # Calcul de la minute en fonction du pourcentage
  } else {
    return(NA)
  }
}

but_minutes <- sapply(but_elements, extract_minutes)
print(but_minutes)
```

## Données de l'encadré 2

Le deuxième encadré permet d'accéder aux compositions des équipes sous forme de tableau, nous devons alors réaliser plusieurs fonctions pour extraire correctement ces données

-   Fonction de récupération des données du tableau.

-   Organiser ces données puis récupérer le nombre de joueurs par lignes pour afficher les formations.

```{r echo=TRUE}
# Fonction pour extraire les joueurs par poste et le manager pour une équipe spécifique
extraire.joueurs <- function(page, section_xpath) {
  section <- page %>% html_nodes(xpath = section_xpath)
  postes <- c("Gardien de but", "Défenseurs", "Milieux de terrain", "Attaquants", "Manager")
  data <- list()
  for (poste in postes) {
    poste_xpath <- sprintf(".//td[b[text()='%s']]/following-sibling::td", poste)
    joueurs <- section %>% html_nodes(xpath = poste_xpath) %>% html_text(trim = TRUE)
    if (length(joueurs) == 0) {
      data[[poste]] <- "Non disponible"
    } else {
      data[[poste]] <- joueurs
    }
  }
  return(data)
}
```

```{r echo=FALSE, class.source="code"}
# Fonction pour extraire les joueurs par poste et le manager pour une équipe spécifique
extraire.joueurs <- function(page, section_xpath) {
  section <- page %>% html_nodes(xpath = section_xpath)
  postes <- c("Gardien de but", "Défenseurs", "Milieux de terrain", "Attaquants", "Manager")
  data <- list()
  for (poste in postes) {
    poste_xpath <- sprintf(".//td[b[text()='%s']]/following-sibling::td", poste)
    joueurs <- section %>% html_nodes(xpath = poste_xpath) %>% html_text(trim = TRUE)
    if (length(joueurs) == 0) {
      data[[poste]] <- "Non disponible"
    } else {
      data[[poste]] <- joueurs
    }
  }
  return(data)
}

extraire_formation <- function(page) {
  section.Home <- "//div[contains(@class, 'large-6') and contains(@class, 'aufstellung') and contains(@class, 'box')]" 
  section.Away <- "//div[contains(@class, 'large-6') and not(contains(@class, 'aufstellung'))]" 
  
  # Extraire les données pour chaque équipe
  Home.data <- extraire.joueurs(page, section.Home) 
  Away.data <- extraire.joueurs(page, section.Away) 
  
  # Fonction pour extraire le nombre de joueurs par poste
  Nb.joueurs.lignes <- function(poste) { 
    joueurs <- strsplit(poste, ",\\s*")[[1]] 
    return(length(joueurs)) 
  } 
  
  # Extraire le nombre de joueurs pour chaque poste
  nombre_joueurs_home <- sapply(Home.data, Nb.joueurs.lignes) 
  nombre_joueurs_away <- sapply(Away.data, Nb.joueurs.lignes) 
  
  # Obtenir les formations
  formation_home <- paste( 
    nombre_joueurs_home["Défenseurs"],  
    nombre_joueurs_home["Milieux de terrain"],  
    nombre_joueurs_home["Attaquants"], sep = "-" 
  ) 
  
  formation_away <- paste( 
    nombre_joueurs_away["Défenseurs"],  
    nombre_joueurs_away["Milieux de terrain"],  
    nombre_joueurs_away["Attaquants"], sep = "-" 
  ) 
  
  # Retourner les formations
  return(list(formation_home = formation_home, formation_away = formation_away))
}

formations <- extraire_formation(page)

# Afficher les résultats
cat("\nFormation équipe à domicile : ", formations$formation_home, "\n") 
cat("Formation équipe à l'extérieur : ", formations$formation_away, "\n")
```

## Données de l'encadré 3

Le troisième encadré joue également un rôle crucial car il détaille les données liées aux buts marqués pendant le match.

```{r echo=FALSE}
# Fonction d'extraction de données de l'encadré 3

extraire_buteurs = function(page, but_minutes) {
  but_events <- page %>% html_nodes(".sb-aktion-aktion") %>% html_text(trim = TRUE)
  buteurs <- page %>% html_nodes(".sb-aktion-aktion a.wichtig") %>% html_text(trim = TRUE)
  passeurs <- page %>%html_nodes(".sb-aktion-aktion a.wichtig") %>%html_text(trim = TRUE)

  # Initialisation des listes
  liste_buteurs <- c()
  liste_passeurs <- c()
  liste_minutes <- c()
  liste_evenements <- c()

  for (i in seq_along(but_events)) {
    if (grepl("but", tolower(but_events[i]), fixed = TRUE)) {
      buteur_match <- buteurs[i]
      # Extraire le passeur après "Passe décisive:"
      passeur_match <- ifelse(grepl("Passe décisive:", but_events[i]), 
                              passeurs[i], 
                              "Non spécifié")
                              
      minute_match <- but_minutes[i]
      evenement_match <- but_events[i]
      
      # Ajouter les informations extraites dans les listes
      liste_buteurs <- c(liste_buteurs, buteur_match)
      liste_passeurs <- c(liste_passeurs, passeur_match)
      liste_minutes <- c(liste_minutes, minute_match)
      liste_evenements <- c(liste_evenements, evenement_match)
    }
  }

  # Création du data frame
  statistiques_buts <- data.frame(
    Minute = liste_minutes,
    Buteur = liste_buteurs,
    Passeur = liste_passeurs,
    Evenement = liste_evenements,
    stringsAsFactors = FALSE
  )
  
  return(statistiques_buts)
}

statistiques_buts <- extraire_buteurs(page, but_minutes)
print(statistiques_buts)
```

## III. Création d'un résumé à partir des données collectées

-   **Création d'un résumé narratif du match.**

```{r echo=FALSE}
# Création du résumé narratif du match

# Vérifiez que les variables sont bien définis avant l'appel
formations <- extraire_formation(page)
formation_home <- formations$formation_home
formation_away <- formations$formation_away
formations <- extraire_formation(page)
statistiques_buts <- extraire_buteurs(page, but_minutes)

# Vérifier si les variables sont extraites correctement
liste_buteurs <- statistiques_buts$Buteur
liste_passeurs <- statistiques_buts$Passeur
liste_minutes <- statistiques_buts$Minute
liste_clubs <- statistiques_buts$Club
# Création du résumé narratif du match
Resum.match <- function(compet, Stade, T.away, T.home, result, spec, formation_home, formation_away, liste_buteurs, liste_passeurs, liste_clubs, liste_minutes) {
 resume = paste(
   "Dans le cadre de la compétition", compet, ", le match opposant", T.home, "à", T.away,
   "s'est déroulé à", Stade, ", devant une foule de", spec, "spectateurs. Ce match s'est soldé sur le score de", result, ".",
   "L'équipe de", T.home, "s'est présentée en", formation_home
 )
 if (formation_home == formation_away) {
   resume = paste(resume, ", tout comme les hommes de", T.away, ", également disposés en", formation_away, ".")
 } else {
   resume = paste(resume, ", tandis que les hommes de", T.away, "étaient disposés en", formation_away, ".")
 }
 if (length(liste_buteurs) > 0) {
   resume <- paste0(resume, " Voici les moments forts du match : ")

   for (i in 1:length(liste_buteurs)) {
     minute <- liste_minutes[i]
     buteur <- liste_buteurs[i]
     passeur <- liste_passeurs[i]
     club <- liste_clubs[i]

     if (passeur != "Non spécifié") {
       event_text <- paste(
         "À la minute", minute, club, "a trouvé le chemin des filets avec un but signé", buteur,
         "grâce à une passe décisive de", passeur, "."
       )
     } else {
       event_text <- paste("À la minute", minute, ", c'est", buteur, "qui a inscrit un magnifique but.")
     }
     resume <- paste0(resume, event_text)
   }
 } else {
   resume <- paste0(resume, " Au cours des 90 minutes, les deux équipes ont donné le meilleur d'elles-mêmes, mais aucune d'elles n'a su se départager. Ce match se solde sur un score nul qui n'arrange personne.")
 }
 resume <- paste0(resume, "\n\nCe match nous à offert 90 minutes de divertissements et nous avons hâte de suivre ces deux équipes pour la suite de la saison.")
 return(resume)
}

# Appel de la fonction Resum.match
resume <- Resum.match(
 compet = compet,
 Stade = Stade,
 T.away = T.away,
 T.home = T.home,
 result = result,
 spec = spec,
 formation_home = formation_home,
 formation_away = formation_away,
 liste_buteurs = liste_buteurs,
 liste_passeurs = liste_passeurs,
 liste_clubs = liste_clubs,
 liste_minutes = liste_minutes
)

# Affichage du résumé
cat(resume)

```

## IV. Automatisation du processus et fonction finale

-   **Création et récupération des différentes fonctions.**
    -   Fonction de récupération/nettoyage de la page HTML
    -   Fonction d'extraction des principales données
    -   Fonction d'extraction des minutes auxquelless ont lieu les buts
    -   Fonction d'extraction des formations
    -   Fonction d'extraction des buteurs et passeurs
    -   Fonction de résumé de match
-   **Restructuration du code en une seule fonction afin d'automatiser le processus.**
    -   Création de la fonction finale à l'aide des fonctions crées ci-dessus
-   **Objectif final : Obtenir le résumé de n'importe quel match avec des statistiques complètes et pertinentes**

## Fonction finale

```{r echo=FALSE}
# Fonction pour générer le résumé
Generation_de_resumes <- function(urlpage, user_agent) {
  clean_html = Fget_page(urlpage, user_agent)
  page = read_html(clean_html)
  
  details = Fextraire_details_match(page)
  but_minutes = Fextract_minutes(page)
  but_stats = Fextraire_buteurs(page, but_minutes)
  formations = Fextraire_formation2(page)
  
  formation_home = formations$formation_home
  formation_away = formations$formation_away
  compet = details$compet
  Stade = details$stadium
  T.away = details$T.away
  T.home = details$T.home
  result = details$result
  spec = details$spectators
  liste_buteurs = but_stats$liste_buteurs
  liste_passeurs = but_stats$liste_passeurs
  liste_clubs = but_stats$liste_clubs

  resume = FResum.match(
    compet = compet,
    Stade = Stade,
    T.away = T.away,
    T.home = T.home,
    result = result,
    spec = spec,
    formation_home = formation_home,
    formation_away = formation_away,
    liste_buteurs = liste_buteurs,
    liste_passeurs = liste_passeurs,
    liste_clubs = liste_clubs,
    liste_minutes = but_minutes
  )
  
  return(resume)
}

# Test avec un autre lien
user_agent = user_agent("Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:132.0) Gecko/20100101 Firefox/132.0")
urlpage = "https://www.transfermarkt.fr/spielbericht/index/spielbericht/4402014"  # Nouveau match
Fonction_Finale = Generation_de_resumes(urlpage, user_agent)
cat(Fonction_Finale)

```

## V. Conclusion du projet

-   **Application pratique des techniques de programmation, notamment le web scraping.**
-   **Automatisation du traitement des données non structurées pour générer des résumés statistiques et narratifs.**
-   **Résolution de défis liés aux spécificités des structures HTML des pages webs ciblée.**
-   **Développement de compétences transférables pour des projets académiques et professionnels futurs**.

## Retour d'expérience et bilan personnel
