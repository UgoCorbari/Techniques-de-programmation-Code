---
title: "Techniques de programmation"
author: "CORBARI UGO SCHNEIDER HUGO"
date: "2025-01-03"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Description du projet

  Pour ce projet rattaché à l'Unité d'Enseignement "Techniques de programmations" nous avons décider de mettre en place un code afin de réaliser des résumés de matchs de football dont les résultats sont présents sur le site Transfermarkt. Ce projet est fondé sur la partie webscrapping du cours, étant donné que ce fut la partie que nous avons le moins bien compris nous avons trouvé intéressant le fait d'approfondir ces techniques dans notre projet. Il s'agit dans un premier temps de récupérer les données du site transfermarkt pour un match. Après avoir obtennu un user agent et avoir néttoyé le fichier HTML nous extrayons les données liées aux équipes, aux scores, aux buteurs ... Une fois ces données obtennus pour un match nous mettrons en place des formules afin de résumer les principaux évènements de ce match, puis nous appliqueront ces formuls pour que notre programme soit capable de produire un résumé pour n'importe quel matchs de football.

```{r, echo=FALSE, results='hide'}
### Packages, et chargement du site

library(httr)
library(stringr)
library(xml2)
library(stringr)
library(tools)
library(rvest)
library(dplyr)

foot = GET('https://www.whatismybrowser.com/detect/what-is-my-user-agent/')
str_match_all(content(foot, "text"), '<div class="value" id="detected_value">(.*?)</div>')[[1]][,2]

user_agent = user_agent("Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:132.0) Gecko/20100101 Firefox/132.0")
foot = GET('https://www.whatismybrowser.com/detect/what-is-my-user-agent/', user_agent)
str_match_all(content(foot, "text"), '<div class="value" id="detected_value">(.*?)</div>')[[1]][,2]

urlpage = 'https://www.transfermarkt.fr/spielbericht/index/spielbericht/4402015'
urlpage

foot = GET(urlpage, user_agent)
html = xml2::read_html(httr::content(foot, "text"))
substr(as.character(html), 1, 2000)

clean_html = str_replace_all(as.character(html),'[\\t\\r\\n\\f]','')


```

## Extractions des données pour un match

Le site présente tous les matchs de la même manière, sur la page correspondant aux résultats du match il y a plusieurs encadrés. Dans un premier temps nous nous concentrerons sur le premier encadré qui fait apparaitre la compétition dans laquelle se déroule le match, les équipes, les scores, le résultat et d'autres données essentielles pour le résumé que nous voulons mettre en place.

```{r}
### Extractions des principalles données de l'encadrée 1 

page <- read_html(clean_html)

# Compétition dans laquelle se déroule le match
compet <- page %>% html_node(".direct-headline__header") %>% html_text(trim = TRUE)

# Équipe jouant à domicile
T.home <- page %>% html_node(".sb-team.sb-heim .sb-vereinslink") %>% html_text(trim = TRUE)

# Équipe se déplacant à l'extérieur
T.away <- page %>% html_node(".sb-team.sb-gast .sb-vereinslink") %>% html_text(trim = TRUE)

# Résultat du match 
result <- page %>% html_node(".sb-endstand") %>% html_text(trim = TRUE)

# Nommbre de spectateurs présents au stade 
spec <- page %>% html_node(".sb-zusatzinfos strong") %>% html_text(trim = TRUE)

# Date et heure du match 
date <- page %>% html_node(".sb-datum.hide-for-small") %>% html_text(trim = TRUE)

# Nom du stade dans lequel se déroule le match
Stade <- page %>% html_node(".sb-zusatzinfos a") %>% html_text(trim = TRUE)

# Résumé de ces informations
cat(sprintf("Compétition: %s\nMatch: %s %s %s\nSpectateurs: %s\nDate et heure: %s\nStade: %s\n",
            compet, T.home, result, T.away, spec, date, Stade))

```

Le deuxième encadré permet d'accéder aux compositions des équipes, une information pertinente pour comprendre la physionomie des matchs.

```{r}
# Fonction pour extraire les joueurs ou manager par poste pour une équipe spécifique

# Sections des équipes
section.Home <- "//div[contains(@class, 'aufstellung-box')]"
section.Away <- "//div[contains(@class, 'aufstellung-bordertop-small')]"

extraire.joueurs <- function(page, section_xpath) {
  section <- page %>% html_nodes(xpath = section_xpath)
  postes <- c("Gardien de but", "Défenseurs", "Milieux de terrain", "Attaquants", "Manager")
  data <- list()
  for (poste in postes) {
    poste_xpath <- sprintf(".//td[b[text()='%s']]/following-sibling::td", poste)
    joueurs <- section %>% html_nodes(xpath = poste_xpath) %>% html_text(trim = TRUE)
    if (length(joueurs) == 0) {
      data[[poste]] <- "Non disponible"
    } else {
      data[[poste]] <- joueurs
    }
  }
  return(data)
}

# Extraire les données pour chaque équipe
Home.data <- extraire.joueurs(page, section_Home)
Away.data <- extraire.joueurs(page, section_Away)

# Afficher les résultats
print(Home.data)
print(Away.data)

```


Le troisième encadré est tout aussi important puisqu'il retranscrit les données liées aux buts au cours du matchs; tels que le nom du buteur et du passeur, la minute à laquelle à eue lieux le but... qui sont peut-être les données les plus importantes pour nôtre résumé.

```{r}
## Extraction des buteurs 

# Extraire les scores
scores <- page %>%
  html_nodes(".sb-aktion-spielstand b") %>%
  html_text(trim = TRUE)

# Extraire les joueurs impliqués (buteurs et passeurs)
players <- page %>%
  html_nodes(".sb-aktion-aktion a.wichtig") %>%
  html_text(trim = TRUE)


# Extraire les équipes
teams <- page %>%
  html_nodes(".sb-aktion-wappen img") %>%
  html_attr("title")

# Extraire les détails des événements
events <- page %>%
  html_nodes(".sb-aktion-aktion") %>%
  html_text(trim = TRUE)
events

length(scores)  # Longueur des scores
length(players) # Longueur des joueurs
length(events)  # Longueur des événements
length(teams)   # Longueur des équipes

# Organiser les données dans un tableau
match_events <- data.frame(
  Score = scores,
  Players = players,
  Events = events,
  Teams = rep(teams, length.out = length(scores)),
  stringsAsFactors = FALSE
)

# Afficher les résultats
print(match_events)


# Exemple de nettoyage pour extraire les noms des buteurs et des passeurs
match_events <- match_events %>%
  mutate(
    GoalScorer = ifelse(grepl("But de la saison", Events), Players, NA),
    AssistProvider = ifelse(grepl("Passe décisive", Events), Players, NA)
  )


```

## 

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
