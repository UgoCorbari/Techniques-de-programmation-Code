---
title: "Techniques de programmation"
author: "CORBARI UGO SCHNEIDER HUGO"
date: "2025-01-03"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Description du projet

  Pour ce projet lié à l'Unité d'Enseignement "Techniques de programmation", nous avons décidé de développer un programme capable de générer des résumés de matchs de football en se basant sur les résultats disponibles sur le site "Transfermarkt". Ce projet s'inscrit dans le cadre de l'apprentissage des techniques de web scraping, une thématique du cours que nous avons trouvée particulièrement intéressante mais assez complexe, doù le fait que nous avons souhaité approfondir cette thématique. 
  L'objectif principal est de récupérer les données d'un match spécifique depuis le site "Transfermarkt". Pour ce faire, nous commençons par configurer un user agent et nettoyer le fichier HTML extrait. Ensuite, nous extrayons des informations telles que les équipes, les scores, les buteurs, et d'autres événements clés du match. Une fois ces données collectées, nous mettons en place des formules permettant de structurer et résumer les principaux événements du match.
  Enfin, nous veillons à automatiser ce processus afin que notre programme puisse produire un résumé détaillé pour n'importe quel match de football disponible sur la plateforme. Ce projet nous a permis de consolider notre compréhension des techniques de web scraping tout en appliquant les concepts appris à travers le cours de manière concrète.


```{r, echo=FALSE, results='hide'}
### Packages, et chargement du site

library(httr)
library(stringr)
library(xml2)
library(stringr)
library(tools)
library(rvest)
library(dplyr)

foot = GET('https://www.whatismybrowser.com/detect/what-is-my-user-agent/')
str_match_all(content(foot, "text"), '<div class="value" id="detected_value">(.*?)</div>')[[1]][,2]

user_agent = user_agent("Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:132.0) Gecko/20100101 Firefox/132.0")
foot = GET('https://www.whatismybrowser.com/detect/what-is-my-user-agent/', user_agent)
str_match_all(content(foot, "text"), '<div class="value" id="detected_value">(.*?)</div>')[[1]][,2]

urlpage = 'https://www.transfermarkt.fr/spielbericht/index/spielbericht/4402015'
urlpage

foot = GET(urlpage, user_agent)
html = xml2::read_html(httr::content(foot, "text"))
substr(as.character(html), 1, 2000)

clean_html = str_replace_all(as.character(html),'[\\t\\r\\n\\f]','')

```

## Extractions des données pour un match

  Le site "Transfermarkt" présente tous les matchs selon une structure homogène. Chaque page dédiée aux résultats d'un match est organisée en plusieurs encadrés. Dans un premier temps, notre travail se concentre sur le premier encadré. Cet encadré contient des informations clés telles que la compétition dans laquelle se déroule le match, les équipes impliquées, les scores, le résultat final, ainsi que d'autres données essentielles à la création du résumé que nous souhaitons mettre en place.

```{r}
### Extractions des principalles données de l'encadrée 1 

page <- read_html(clean_html)

# Compétition dans laquelle se déroule le match
compet <- page %>% html_node(".direct-headline__header") %>% html_text(trim = TRUE)

# Équipe jouant à domicile
T.home <- page %>% html_node(".sb-team.sb-heim .sb-vereinslink") %>% html_text(trim = TRUE)

# Équipe se déplacant à l'extérieur
T.away <- page %>% html_node(".sb-team.sb-gast .sb-vereinslink") %>% html_text(trim = TRUE)

# Résultat du match 
result <- page %>% html_node(".sb-endstand") %>% html_text(trim = TRUE)

# Nommbre de spectateurs présents au stade 
spec <- page %>% html_node(".sb-zusatzinfos strong") %>% html_text(trim = TRUE)

# Date et heure du match 
date <- page %>% html_node(".sb-datum.hide-for-small") %>% html_text(trim = TRUE)

# Nom du stade dans lequel se déroule le match
Stade <- page %>% html_node(".sb-zusatzinfos a") %>% html_text(trim = TRUE)

# Résumé de ces informations
cat(sprintf("Compétition: %s\nMatch: %s %s %s\nSpectateurs: %s\nDate et heure: %s\nStade: %s\n",
            compet, T.home, result, T.away, spec, date, Stade))

```

  Le deuxième encadré permet d'accéder aux compositions des équipes, une information pertinente pour comprendre la physionomie des matchs.

```{r}
# Fonction pour extraire les joueurs ou manager par poste pour une équipe spécifique

# Sections des équipes
section.Home <- "//div[contains(@class, 'aufstellung-box')]"
section.Away <- "//div[contains(@class, 'aufstellung-bordertop-small')]"

extraire.joueurs <- function(page, section_xpath) {
  section <- page %>% html_nodes(xpath = section_xpath)
  postes <- c("Gardien de but", "Défenseurs", "Milieux de terrain", "Attaquants", "Manager")
  data <- list()
  for (poste in postes) {
    poste_xpath <- sprintf(".//td[b[text()='%s']]/following-sibling::td", poste)
    joueurs <- section %>% html_nodes(xpath = poste_xpath) %>% html_text(trim = TRUE)
    if (length(joueurs) == 0) {
      data[[poste]] <- "Non disponible"
    } else {
      data[[poste]] <- joueurs
    }
  }
  return(data)
}

# Extraire les données pour chaque équipe
Home.data <- extraire.joueurs(page, section.Home)
Away.data <- extraire.joueurs(page, section.Away)

# Afficher les résultats
print(Home.data)
print(Away.data)

```


 Le troisième encadré joue également un rôle crucial, car il détaille les données liées aux buts marqués pendant le match. Il fournit des informations telles que le nom du buteur, celui du passeur décisif, ainsi que la minute à laquelle chaque but a été inscrit. Ces données sont particulièrement pertinentes pour enrichir et personnaliser le résumé que nous souhaitons élaborer, en mettant en avant les moments clés du match.

```{r}
## Extraction des buteurs 

# Extraire les scores
scores <- page %>%
  html_nodes(".sb-aktion-spielstand b") %>%
  html_text(trim = TRUE)

# Extraire les joueurs impliqués (buteurs et passeurs)
players <- page %>%
  html_nodes(".sb-aktion-aktion a.wichtig") %>%
  html_text(trim = TRUE)


# Extraire les équipes
teams <- page %>%
  html_nodes(".sb-aktion-wappen img") %>%
  html_attr("title")

# Extraire les détails des événements
events <- page %>%
  html_nodes(".sb-aktion-aktion") %>%
  html_text(trim = TRUE)
events

length(scores)  # Longueur des scores
length(players) # Longueur des joueurs
length(events)  # Longueur des événements
length(teams)   # Longueur des équipes

# Organiser les données dans un tableau
match_events <- data.frame(
  Score = scores,
  Players = players,
  Events = events,
  Teams = rep(teams, length.out = length(scores)),
  stringsAsFactors = FALSE
)

# Afficher les résultats
print(match_events)


# Exemple de nettoyage pour extraire les noms des buteurs et des passeurs
match_events <- match_events %>%
  mutate(
    GoalScorer = ifelse(grepl("But de la saison", Events), Players, NA),
    AssistProvider = ifelse(grepl("Passe décisive", Events), Players, NA)
  )


```

Automatisation du processus 

```{r}
# Exemple d'utilisation pour un match
url_match <- "https://www.transfermarkt.fr/spielbericht/index/spielbericht/4402013"
match_data <- tryCatch(
  extract_match_data(url_match),
  error = function(e) {
    cat("Erreur lors de l'extraction des données : ", e$message, "\n")
    NULL
  }
)

# Afficher un tableau propre avec les statistiques
if (!is.null(match_data)) {
  # Tableau des informations principales
  summary_table <- data.frame(
    Competition = match_data$Competition,
    HomeTeam = match_data$HomeTeam,
    AwayTeam = match_data$AwayTeam,
    Result = match_data$Result,
    Spectators = match_data$Spectators,
    DateTime = match_data$DateTime,
    Stadium = match_data$Stadium,
    stringsAsFactors = FALSE
  )
  
  # Afficher les statistiques principales
  cat("\n=== Statistiques Principales ===\n")
  print(summary_table)
  
  # Afficher le tableau des événements
  cat("\n=== Événements du Match ===\n")
  print(match_data$Events)
  
} else {
  cat("Les données du match n'ont pas pu être extraites.\n")
}

View(summary_table)

```

## 

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
