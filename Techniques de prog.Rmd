---
title: "Techniques de programmation"
author: "CORBARI UGO SCHNEIDER HUGO"
date: "2025-01-03"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Description du projet

  Pour ce projet lié à l'Unité d'Enseignement "Techniques de programmation", nous avons décidé de développer un programme capable de générer des résumés de matchs de football en se basant sur les résultats disponibles sur le site "Transfermarkt". Ce projet s'inscrit dans le cadre de l'apprentissage des techniques de web scraping, une thématique du cours que nous avons trouvée particulièrement intéressante mais assez complexe, doù le fait que nous avons souhaité approfondir cette thématique. 
  L'objectif principal est de récupérer les données d'un match spécifique depuis le site "Transfermarkt". Pour ce faire, nous commençons par configurer un user agent et nettoyer le fichier HTML extrait. Ensuite, nous extrayons des informations telles que les équipes, les scores, les buteurs, et d'autres événements clés du match. Une fois ces données collectées, nous mettons en place des formules permettant de structurer et résumer les principaux événements du match.
  Enfin, nous veillons à automatiser ce processus afin que notre programme puisse produire un résumé détaillé pour n'importe quel match de football disponible sur la plateforme. Ce projet nous a permis de consolider notre compréhension des techniques de web scraping tout en appliquant les concepts appris à travers le cours de manière concrète.


```{r, echo=FALSE, results='hide'}
### Importation des packages et configuration

# Chargement des librairies nécessaires 
library(httr)
library(stringr)
library(xml2)
library(stringr)
library(tools)
library(rvest)
library(dplyr)

# Configuration d'un User-Agent spécifique, définition de l'URL de la page cible et nettoyage de la page HTML
foot = GET('https://www.whatismybrowser.com/detect/what-is-my-user-agent/')
str_match_all(content(foot, "text"), '<div class="value" id="detected_value">(.*?)</div>')[[1]][,2]

user_agent = user_agent("Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:132.0) Gecko/20100101 Firefox/132.0")
foot = GET('https://www.whatismybrowser.com/detect/what-is-my-user-agent/', user_agent)
str_match_all(content(foot, "text"), '<div class="value" id="detected_value">(.*?)</div>')[[1]][,2]

urlpage = 'https://www.transfermarkt.fr/spielbericht/index/spielbericht/4402015'
urlpage

foot = GET(urlpage, user_agent)
html = xml2::read_html(httr::content(foot, "text"))
substr(as.character(html), 1, 2000)

clean_html = str_replace_all(as.character(html),'[\\t\\r\\n\\f]','')

```

## Extractions des données pour un match

  Le site "Transfermarkt" présente tous les matchs selon une structure homogène. Chaque page dédiée aux résultats d'un match est organisée en plusieurs encadrés. Dans un premier temps, notre travail se concentre sur le premier encadré. Cet encadré contient des informations clés telles que la compétition dans laquelle se déroule le match, les équipes impliquées, les scores, le résultat final, ainsi que d'autres données essentielles à la création du résumé que nous souhaitons mettre en place.

```{r}
### Extractions des principalles données de l'encadré 1

page <- read_html(clean_html)

compet <- page %>% html_node(".direct-headline__header") %>%  html_text(trim = TRUE)            #Compétition

T.home <- page %>% html_node(".sb-team.sb-heim .sb-vereinslink") %>% html_text(trim = TRUE)     #Equipe Domicile

T.away <- page %>% html_node(".sb-team.sb-gast .sb-vereinslink") %>% html_text(trim = TRUE)     #Equipe Exterieur

result <- page %>% html_node(".sb-endstand") %>%html_text(trim = TRUE)                          # Résultat


# Nombre de spectateurs présents au stade 
spec <- page %>% html_node(".sb-zusatzinfos strong") %>% html_text(trim = TRUE)

date <- page %>% html_node(".sb-datum.hide-for-small") %>% html_text(trim = TRUE)               #Date du match

Stade <- page %>% html_node(".sb-zusatzinfos a") %>% html_text(trim = TRUE)                     #Nom du stade

# Résumé de ces informations
cat(sprintf("Compétition: %s\nMatch: %s %s %s\nSpectateurs: %s\nDate et heure: %s\nStade: %s\n",
            compet, T.home, result, T.away, spec, date, Stade))

```

  Le deuxième encadré permet d'accéder aux compositions des équipes, une information pertinente pour comprendre la physionomie des matchs.

```{r}
# Fonction pour extraire les joueurs par poste et le manager pour une équipe spécifique

# Sections des équipes
section.Home <- "//div[contains(@class, 'large-6') and contains(@class, 'aufstellung') and contains(@class, 'box')]"
section.Away <- "//div[contains(@class, 'large-6') and not(contains(@class, 'aufstellung'))]"


extraire.joueurs <- function(page, section_xpath) {
  section <- page %>% html_nodes(xpath = section_xpath)
  postes <- c("Gardien de but", "Défenseurs", "Milieux de terrain", "Attaquants", "Manager")
  data <- list()
  for (poste in postes) {
    poste_xpath <- sprintf(".//td[b[text()='%s']]/following-sibling::td", poste)
    joueurs <- section %>% html_nodes(xpath = poste_xpath) %>% html_text(trim = TRUE)
    if (length(joueurs) == 0) {
      data[[poste]] <- "Non disponible"
    } else {
      data[[poste]] <- joueurs
    }
  }
  return(data)
}

# Extraire les données pour chaque équipe
Home.data <- extraire.joueurs(page, section.Home)
Away.data <- extraire.joueurs(page, section.Away)

# Afficher les résultats
print(Home.data)
print(Away.data)

# Fonction pour extraire le nombre de joueurs pour chaque poste
Nb.joueurs.lignes <- function(poste) {
  joueurs <- strsplit(poste, ",\\s*")[[1]]
  return(length(joueurs))
}

# Appliquer la fonction pour obtenir le nombre de joueurs pour chaque poste pour Home et Away
nombre_joueurs_home <- sapply(Home.data, Nb.joueurs.lignes)
nombre_joueurs_away <- sapply(Away.data, Nb.joueurs.lignes)

# Afficher les résultats
print("Formation équipe domicile")
print(nombre_joueurs_home)

print("Formation équipe extérieur")
print(nombre_joueurs_away)


# Obtennir les formations
formation_home <- paste(
  nombre_joueurs_home["Défenseurs"], 
  nombre_joueurs_home["Milieux de terrain"], 
  nombre_joueurs_home["Attaquants"], sep = "-"
)

formation_away <- paste(
  nombre_joueurs_away["Défenseurs"], 
  nombre_joueurs_away["Milieux de terrain"], 
  nombre_joueurs_away["Attaquants"], sep = "-"
)

cat("\nFormation équipe à domicile : ", formation_home, "\n")
cat("Formation équipe à l'extérieur : ", formation_away, "\n")


```


 Le troisième encadré joue également un rôle crucial, car il détaille les données liées aux buts marqués pendant le match. Il fournit des informations telles que le nom du buteur, celui du passeur décisif, ainsi que la minute à laquelle chaque but a été inscrit. Ces données sont particulièrement pertinentes pour enrichir et personnaliser le résumé que nous souhaitons élaborer, en mettant en avant les moments clés du match.

```{r}
# Extraction de données de l'encadré 3 

but_details <- page %>%html_nodes(".sb-aktion-aktion") %>%html_text(trim = TRUE)              #Evenements liés aux buts

but_events <- grep("But de la saison", but_details, value = TRUE)                             #Filtrage des données 

buteurs <- page %>%html_nodes(".sb-aktion-aktion a.wichtig") %>%html_text(trim = TRUE)        #Extraction de buteurs

liste_buteurs <- c()                                                                   # Initialisation des listes pour les buteurs 
liste_passeurs <- c()                                                                  # Initialisation des listes pour les passeurs

# Fonction d'extraction des statistiques
for (event in but_events) {
  buteur_match <- sub(",.*", "", event)                                               #On extrait le(s) buteur(s) et on les ajoutes 
  liste_buteurs <- c(liste_buteurs, buteur_match)                                     #dans la liste vide 
  
  passeur_match <- ifelse(grepl("Passe décisive:", event),
                          sub(".*Passe décisive: (.+?),.*", "\\1", event),            #Extraction des passeurs si identifiés 
                          "Non spécifié")                                             #Si non, passeur non mentionné
  liste_passeurs <- c(liste_passeurs, passeur_match)
}

# On créer un data frame pour rassembler les informations
statistiques_buts <- data.frame(
  Buteur = liste_buteurs,
  Passeur = liste_passeurs,
  Details = but_events,
  stringsAsFactors = FALSE
)

print(statistiques_buts)

```

  Une fois les données extraites il est possible de créer un résumé naratif du match 

```{r}
#Création du résumé
Resum.match<- function(competition, stade, T.away, T.home, score, spectateurs, evenements, formation_home, formation_away, Home.data) {
  resume <- sprintf(
    "Dans le cadre de la compétition %s, le match opposant %s et %s s'est déroulé au %s devant une foule de %s spectateurs. Ce match s'est soldé sur le score de  %s.L'équipe de %s s'est présenté en %s tandis que les hommes de %s étaient disposés en %s. \n\n", 
    compet, T.home, T.away, stade, spec, result, T.home, formation_home, Home.data$Manager, formation_away
  )
  
  if (nrow(evenements) > 0) {
    resume <- paste0(resume, "Voici les moments forts du match : ")
    for (i in 1:nrow(evenements)) {
      minute <- evenements$Minute[i]
      buteur <- evenements$Buteur[i]
      passeur <- evenements$Passeur[i]
      
      if (passeur != "Non spécifié") {
        event_text <- sprintf(
          "À la %s minute, %s a trouvé le chemin des filets grâce à une passe décisive de %s. ", 
          minute, buteur, passeur
        )
      } else {
        event_text <- sprintf("À la %s minute, %s a inscrit un magnifique but. ", minute, buteur)
      }
      
      resume <- paste0(resume, event_text)
    }
  } else {
    resume <- paste0(resume, "Aucun événement notable n'a été enregistré pendant ce match.")
  }
  
  # Conclusion
  resume <- paste0(resume, "\n\nCe match restera dans les mémoires pour ses moments forts et l'intensité du jeu.")
  
  # Retourner le résumé final
  return(resume)
}

# Exemple de données extraites
competition <- "Ligue 1"
stade <- "Parc des Princes"
equipe_home <- "Paris Saint-Germain"
equipe_away <- "Olympique de Marseille"
score <- "3-1"
spectateurs <- "48,712"

# Exemple de dataframe des événements
evenements <- data.frame(
  Minute = c("15", "45", "67", "89"),
  Buteur = c("Mbappé", "Neymar", "Messi", "Ramos"),
  Passeur = c("Hakimi", "Non spécifié", "Verratti", "Non spécifié"),
  stringsAsFactors = FALSE
)

# Générer le résumé
resume <- creer_resume_journalistique(competition, stade, equipe_home, equipe_away, score, spectateurs, evenements)

# Afficher le résumé
cat(resume)

```






  Automatisation du processus 

```{r}
# Fonction d'extraction des données d'un match afin d'automatiser le processus
# Fonction d'extraction des données d'un match
extract_match_data <- function(match_url) {
  # Charger les librairies nécessaires
  library(httr)
  library(stringr)
  library(xml2)
  library(rvest)
  library(dplyr)
  
  # Configurer le user-agent
  user_agent <- user_agent("Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:132.0) Gecko/20100101 Firefox/132.0")
  
  # Requête GET pour récupérer le contenu HTML
  response <- GET(match_url, user_agent)
  
  # Vérifier si la requête a réussi
  if (response$status_code != 200) {
    stop("Erreur : La requête a échoué. Vérifiez l'URL ou la connexion réseau.")
  }
  
  # Charger et nettoyer le contenu HTML
  html <- read_html(content(response, "text"))
  clean_html <- str_replace_all(as.character(html), '[\\t\\r\\n\\f]', '')
  page <- read_html(clean_html)
  
  # Extraire les informations principales (encadré 1)
  competition <- page %>% html_node(".direct-headline__header") %>% html_text(trim = TRUE)
  home_team <- page %>% html_node(".sb-team.sb-heim .sb-vereinslink") %>% html_text(trim = TRUE)
  away_team <- page %>% html_node(".sb-team.sb-gast .sb-vereinslink") %>% html_text(trim = TRUE)
  result <- page %>% html_node(".sb-endstand") %>% html_text(trim = TRUE)
  spectators <- page %>% html_node(".sb-zusatzinfos strong") %>% html_text(trim = TRUE)
  date_time <- page %>% html_node(".sb-datum.hide-for-small") %>% html_text(trim = TRUE)
  stadium <- page %>% html_node(".sb-zusatzinfos a") %>% html_text(trim = TRUE)
  
  # Extraire les événements du match (encadré 3)
  scores <- page %>% html_nodes(".sb-aktion-spielstand b") %>% html_text(trim = TRUE)
  players <- page %>% html_nodes(".sb-aktion-aktion a.wichtig") %>% html_text(trim = TRUE)
  teams <- page %>% html_nodes(".sb-aktion-wappen img") %>% html_attr("title")
  events <- page %>% html_nodes(".sb-aktion-aktion") %>% html_text(trim = TRUE)
  
  # Ajuster les vecteurs pour correspondre à la longueur maximale
  max_length <- max(length(scores), length(players), length(events), length(teams))
  scores <- c(scores, rep(NA, max_length - length(scores)))
  players <- c(players, rep(NA, max_length - length(players)))
  events <- c(events, rep(NA, max_length - length(events)))
  teams <- c(teams, rep(NA, max_length - length(teams)))
  
  # Organiser les données des événements
  match_events <- data.frame(
    Score = scores,
    Players = players,
    Events = events,
    Teams = teams,
    stringsAsFactors = FALSE
  ) %>%
    mutate(
      GoalScorer = ifelse(grepl("But de la saison", Events), Players, NA),
      AssistProvider = ifelse(grepl("Passe décisive", Events), Players, NA)
    )
  
  # Créer une liste avec les informations principales et les événements
  match_summary <- list(
    Competition = competition,
    HomeTeam = home_team,
    AwayTeam = away_team,
    Result = result,
    Spectators = spectators,
    DateTime = date_time,
    Stadium = stadium,
    Events = match_events
  )
  
  return(match_summary)
}

# Exemple d'utilisation pour un match
url_match <- "https://www.transfermarkt.fr/spielbericht/index/spielbericht/4402015"
match_data <- tryCatch(
  extract_match_data(url_match),
  error = function(e) {
    cat("Erreur lors de l'extraction des données : ", e$message, "\n")
    NULL
  }
)

# Afficher un tableau propre avec les statistiques
if (!is.null(match_data)) {
  # Tableau des informations principales
  summary_table <- data.frame(
    Competition = match_data$Competition,
    HomeTeam = match_data$HomeTeam,
    AwayTeam = match_data$AwayTeam,
    Result = match_data$Result,
    Spectators = match_data$Spectators,
    DateTime = match_data$DateTime,
    Stadium = match_data$Stadium,
    stringsAsFactors = FALSE
  )
  
  # Afficher les statistiques principales
  cat("\n=== Statistiques Principales ===\n")
  print(summary_table)
  
  # Afficher le tableau des événements
  cat("\n=== Événements du Match ===\n")
  print(match_data$Events)
  
} else {
  cat("Les données du match n'ont pas pu être extraites.\n")
}

```

## 

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
